<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title> Posts</title>
  <style type="text/css">
    body {
      font-family: sans-serif;
      margin: 20px;
      background-color: #f4f4f4;
      color: #333;
    }
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 20px;
    }
    #user-info {
      background-color: #e9ecef;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 20px;
      text-align: center;
    }
    .post-form {
      background-color: #fff;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .post-form h2 {
      color: #333;
      margin-top: 0;
      margin-bottom: 15px;
      text-align: center;
    }
    .post-form div {
      margin-bottom: 15px;
    }
    .post-form label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #555;
    }
    .post-form input[type="text"],
    .post-form textarea {
      width: calc(100% - 12px);
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    .post-form button#submit {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 10px 15px;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
    }
    .posts-display {
      background-color: #fff;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .posts-display h3 {
      color: #333;
      margin-top: 0;
      margin-bottom: 15px;
      text-align: center;
    }
    .search-bar {
      display: flex;
      margin-bottom: 15px;
    }
    .search-bar input[type="text"] {
      flex-grow: 1;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 5px 0 0 5px;
    }
    .search-bar button#search-button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 15px;
      font-size: 16px;
      border-radius: 0 5px 5px 0;
      cursor: pointer;
    }
    .post-list {
      margin-top: 15px;
    }
    .post-item {
      border: 1px solid #eee;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 5px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background-color: #f9f9f9;
    }
    .post-title {
      font-weight: bold;
      color: #333;
    }
    .post-content {
      color: #555;
    }
    .post-images {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .post-image-space {
      width: 60px;
      height: 60px;
      background-color: #ddd;
      border: 1px dashed #ccc;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 0.7em;
      color: #777;
      border-radius: 5px;
      overflow: hidden;
    }
    .post-image-space img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .delete-button {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 8px 12px;
      font-size: 14px;
      border-radius: 5px;
      cursor: pointer;
      align-self: flex-start;
    }
    .delete-button:hover {
      background-color: #c82333;
    }
    #numposts {
      color: #777;
      text-align: center;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <h1>Manage Posts</h1>
  <div id="user-info">
    <p>User ID: <span id="uid-display"></span></p>
  </div>

  <form id="add-post-form" class="post-form">
    <h2>Create New Post</h2>
    <div>
      <label for="post-title">Post Title:</label>
      <input type="text" id="post-title" name="post-title" placeholder="Enter title">
    </div>
    <div>
      <label for="post-content">Content:</label>
      <textarea id="post-content" name="post-content" placeholder="Enter content"></textarea>
    </div>
    <button type="submit" id="submit">Add Post</button>
  </form>

  <div class="posts-display">
    <h3>View and Delete Posts</h3>
    <div class="search-bar">
      <input type="text" id="search-input" placeholder="Search posts by title or content...">
      <button id="search-button">Search</button>
    </div>
    <h4 id="numposts"></h4>
    <div id="post-list"></div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js';

    const supabaseUrl = 'https://vefcftvmjuksycmyrvmi.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZlZmNmdHZtanVrc3ljbXlydm1pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDIxMTI4OTgsImV4cCI6MjA1NzY4ODg5OH0.VXcB8J56mK51kIGqBzYPZUh8d1wQ5rR4DlyA22r-vsA';
    const supabase = createClient(supabaseUrl, supabaseKey);

    function getUserIdFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('user_id');
    }

    const uid = getUserIdFromUrl();

    if (!uid) {
      window.location.replace('login.html');
    } else {
      document.getElementById('uid-display').textContent = uid;
      displayPosts();
    }

    document.getElementById('add-post-form').addEventListener('submit', async (event) => {
      event.preventDefault();
      const postTitle = document.getElementById('post-title').value;
      const postContent = document.getElementById('post-content').value;

      if (supabase && uid) {
        const { data, error } = await supabase
          .from('posts')
          .insert([{ user_id: uid, title: postTitle, content: postContent }]);

        if (error) {
          console.error('Error creating post:', error);
          alert('Failed to create post.');
        } else {
          alert('Post created successfully!');
          document.getElementById('add-post-form').reset();
          displayPosts();
        }
      } else {
        alert('Authentication or Supabase client issue.');
      }
    });

    async function deletePost(postId) {
      if (supabase && uid) {
        const { error } = await supabase
          .from('posts')
          .delete()
          .eq('id', postId)
          .eq('user_id', uid);

        if (error) {
          console.error('Error deleting post:', error);
          alert('Failed to delete post.');
        } else {
          alert('Post deleted successfully!');
          displayPosts();
        }
      } else {
        alert('Authentication or Supabase client issue.');
      }
    }

    async function displayPosts(searchTerm = '') {
      if (supabase && uid) {
        try {
          let query = supabase
            .from('posts')
            .select('id, title, content, image_url_1, image_url_2, image_url_3, image_url_4', { count: 'exact' })
            .eq('user_id', uid);

          if (searchTerm) {
            query = query.ilike('title', `%${searchTerm}%`).or('ilike', 'content', `%${searchTerm}%`);
          }

          const { data, error, count } = await query;
          const postsListDiv = document.getElementById('post-list');
          postsListDiv.innerHTML = '';
          document.getElementById('numposts').textContent = count ? `Total Posts: ${count}` : 'No posts yet.';

          if (error) {
            console.error('Error fetching posts:', error);
            postsListDiv.textContent = 'Failed to load posts.';
          } else if (data && data.length > 0) {
            data.forEach(post => {
              const postItem = document.createElement('div');
              postItem.classList.add('post-item');

              const titleElement = document.createElement('div');
              titleElement.classList.add('post-title');
              titleElement.textContent = post.title;

              const contentElement = document.createElement('div');
              contentElement.classList.add('post-content');
              contentElement.textContent = post.content;

              const imagesContainer = document.createElement('div');
              imagesContainer.classList.add('post-images');
              for (let i = 1; i <= 4; i++) {
                const imageUrl = post[`image_url_${i}`];
                const imageSpace = document.createElement('div');
                imageSpace.classList.add('post-image-space');
                if (imageUrl) {
                  const imgElement = document.createElement('img');
                  imgElement.src = imageUrl;
                  imgElement.alt = `Image ${i}`;
                  imageSpace.appendChild(imgElement);
                } else {
                  imageSpace.textContent = `Img ${i}`;
                }
                imagesContainer.appendChild(imageSpace);
              }

              const deleteButton = document.createElement('button');
              deleteButton.classList.add('delete-button');
              deleteButton.textContent = 'Delete Post';
              deleteButton.addEventListener('click', () => deletePost(post.id));

              postItem.appendChild(titleElement);
              postItem.appendChild(contentElement);
              postItem.appendChild(imagesContainer);
              postItem.appendChild(deleteButton);
              postsListDiv.appendChild(postItem);
            });
          } else {
            postsListDiv.textContent = 'No posts found.';
          }
        } catch (error) {
          console.error('Unexpected error fetching posts:', error);
          document.getElementById('post-list').textContent = 'Failed to load posts.';
          document.getElementById('numposts').textContent = '';
        }
      }
    }

    document.getElementById('search-button').addEventListener('click', () => {
      const searchTerm = document.getElementById('search-input').value.trim();
      displayPosts(searchTerm);
    });

    document.getElementById('search-input').addEventListener('keypress', (event) => {
      if (event.key === 'Enter') {
        document.getElementById('search-button').click();
      }
    });
  </script>
</body>
</html>
